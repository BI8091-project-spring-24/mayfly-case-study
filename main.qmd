---
title: "A practical application of the pointedSDM package (with a reproducible workflow)"
format: html
editor: visual
---

# Introduction

\[alternative title suggestion: A protocol for GBIF data exploration and filtering for Integrated Species Distribution Models\]

Modern ecological research is increasingly coming to be characterized by the use of large, multi-source data sets from open-access online repositories - with the infrastructure provided by the Global Biodiversity Information Facility (GBIF) as perhaps the most prominent example. These "big data" on species occurrences are often used to inform species distribution models, where \[say something more here?\]. However, the fact that the data resulting from a single GBIF query (or a similar repository) often come from widely different sources, with different levels of sampling structure, information on species absences etc., remains a challenge.

Recent advances in species distribution modelling, exemplified with the release of the `R` package `pointedSDM` (REF), does increasingly allow for the combination of multiple species occurrence data sets with different levels of sample information (i.e. presence-only, presence-absence, counts etc), into a single integrated model (iSDM). Still, practical and actionable advice for how to best obtain, validate and prepare this differentiated data from an online repository, seems to be comparatively lacking in the literature.

In this report, we aim to address this issue by demonstrating a suggestion for a complete and reproducible workflow for the download, cleaning, exploration and differentiating of a species occurrence dataset, from a simple GBIF query to fitting an integrated SDM with the `pointedSDM` package.

## Case study

As a case study, we will use the occurrences of the mayfly species *Baetis rhodani*, whose GBIF occurrence data in Norway is known to contain both structured and unstructured samples. In order to assess the value of our approach over more "naÃ¯ve" ways of modelling the data, we will compare the output of four different SDMs: a presence-only version of our complete GBIF dataset, a presence-absence model of the subset of the data that is determined to be from structured survey, a presence-only model of the subset of the data that is presence-only, and an iSDM of the presence-absence and presence-only subsets of the data.

### \[Original intro\]

Study: A practical application of the pointedSDM package (with a reproducible workflow).

This report documents the different steps in the mayfly case study, created for the course Advanced biology BI8091 at NTNU, Spring 2024. The analysis consists of several steps: Selection of invertebrate data points, preparation of environmental variables, running the SDMs and interpreting/discussing the results and possible implications.

### Species distribution modelling

The aim of the project is to investigate how species distribution models can be used with different data types (presence-only, presence-absence, occurrence), and how the inclusion of both "good" and "less informative" data impact possible future predictions of species distribution. The R package pointedSDMs "[https://CRAN.R-project.org/package=PointedSDMs](https://cran.r-project.org/package=PointedSDMs)" by Mostert & O'hara is used for species distribution modelling.

### Study organism

The case study will focus on the mayfly species *Baetis rhodani* , also called the Large dark olive mayfly. Nymphs of *B. rhodani* is commonly found in running waters all over Norway (Artsdatabanken, 2021) and can also be found in most of Western-Europe. *B. rhodani* adults are winged and inhabit the terrestrial habitat for a limited time in order to reproduce. They cannot feed in their adult stage, so their life on land is short - typically lasting a few days. Not many studies have measured the dispersal distance of adult Mayflies. A study from 2021 aggregating flying distances for EPTs (Arce et al., 2021) cite only one study for *B. rhodani*, which had measured adults flying more than 3700 meters (Bagge, 1995).

We assume that most of the *B. rhodani* datapoints from Norway originate from aquatic sampling, which for some datasets can be verified (ie., the NTNU University Museum) and for others inferred based on proximity to the river network. Some adult mayfiles may also show up in the data set. This will be handled... (add text here).

### Data

Mayfly data is accessed through the Global Biodiversity Information Facility (GBIF, ref). Norway is selected as study area, due to the availability of both high-quality species occurrence data (NTNU University Museum) and presence-only data from national monitoring and research. Easily accessible physical, climatic and geographical data also makes Norway a good case-study.

## Workflow organization

The workflow for this example is organized in numbered `R` scripts in the `code` folder of this repository. In the sections below,

# Workflow

## 0. Setup

Load packages: Downloading and loading required packages using a function that checks whether each package is already downloaded, and only downloads it if not present.

```{r 0_setup}
#| output: false

source("code/0_setup.R")
```

## 1. Load *Baetis rhodani* data from GBIF

In this project, we use data on the mayfly *Baetis rhodani* accessed via GBIF. The GBIF infrastructure provides several options for data download, which all require a GBIF user. Creating a user is free and open for all. Searching for and downloading data can be done via the GBIF website (link here), or it can be done via R using the "rgbif" package. We will demonstrate the latter, at it improves reproducibility.

First, a download request is created. Here we specify the download criteria:

-   Species: Baetis rhodani (Pictet, 1843)

-   Global administrative area: Norway

-   Basis of record: Everything

-   Year range: 1950-current

Then, the data is imported and saved as the file `insectdata.rda`. Creating a download request from GBIF only needs to be done once. Afterwards, the dataset from the download request can be accessed directly through a download key or using a API-link. We use a download key to import the dataset.

```{r load_GBIF_data }
#| output: true
#| error: true

# Load script: GBIF download
# source(here::here("code","1_1_GBIF_download.R"))
  # Script for creating a new download request to GBIF. Only run if necessary.

# Load script: GBIF import
source(here::here("code","1_2_GBIF_import.R"))

```

## 2. GBIF data cleaning

Before looking into the different sources and "quality levels" of the data, in the dataset, we first clean the downloaded dataset: removing data points with flagged coordinates, temporal outliers, and low coordinate precision (\>1km). The full cleaning procedure is provided in more detail in the script `1_3_GBIF_data_cleaning.R`.

```{r run-cleaning}
source(here::here("code","1_3_GBIF_data_cleaning.R"))

```

### Procedure (simplified)

-   Visualize the raw data

-   Then, remove records with problematic coordinates and plot the flagged records.

-   Finally, we test for temporal outliers on the taxon level, and remove the records

To improve the precision and our confidence in the data further, we can use the metadata included in the dataset.

-   First, we make a boxplot of the coordinate precisions reported for the insect data.

-   Then, we calculate some summary stats for the coordinate uncertainties, make a table of each value's frequency, and inspect it.

-   Then, remove records with coordinate uncertainty \>3km and records with NA for coordinate uncertainty.

-   Save the cleaned files. The cleaned dataset is now called insectdata_low_uncertainty (?).

The cleaned data is visualized in @fig-coords, with points removed in the cleaning procedure marked in red.

```{r plot_maps}
#| label: fig-coords
#| layout-ncol: 1
#| fig-cap: "Coordinates for the cleaned occurrences (blue, $N=23434$) of B. Rhodani in Norway, and removed points (red, $N=124$)."
#| truncate: true

#filter out the filtered-out observations
removed_obs <- subset(insectdata, !(occurrenceID %in% cleaned_insectdata$occurrenceID))

# make plot of raw v cleaned obs
ggplot() +
  coord_fixed() +
  borders(database="world",
          regions="Norway(?!:Svalbard)", colour = "gray70", fill = "gray90",
          xlim=c(4.5, 32)) +
  geom_point(data = cleaned_insectdata,
             aes(x = decimalLongitude, y = decimalLatitude),
             colour = "darkblue",
             size = 0.5) +
  geom_point(data = removed_obs,
             aes(x = decimalLongitude, y = decimalLatitude),
             colour = "red",
             size = 0.5) +
  coord_quickmap() +
  theme_classic()

```

## 3. Data exploration

The cleaned data originates from different data providers. The 10 largest data sources are shown below in @fig-institutions-bar, and we see that after The NTNU University Museum (NTNU-VM), The Norwegian Environmental Agency (miljodir) and The Norwegian Institute for Nature Research (NINA) are the institutions providing the highest number of data points.

```{r run-exploration-script}
# Run script
source(here::here("code","1_4_GBIF_data_exploration.R"))
```

```{r}
#| label: fig-institutions-bar
#| layout-ncol: 1
#| fig-cap: "Barplot of occurences per insitution listed as data providers in the cleaned GBIF dataset."
#| truncate: true
df_institutions_barplot
```

As visualized in @fig-institutions-points, the *B. rhodani* data points are distributed across Norway, with higher concentrations of data points visible near large cities.

```{r plot-instituions}
#| label: fig-institutions-points
#| layout-ncol: 1
#| fig-cap: "Coordinates for the samples provided by the the largest data providers in the study: The NTNU University Museum (NTNU-VM), the Norwegian Environmental Agency (miljodir) and the Norwegian Institute for Nature Research (NINA)."
#| truncate: true
largest_providers <- cleaned_insectdata |> filter(institutionCode %in% c("NTNU-VM", "miljodir", "NINA"))
ggplot() +
  coord_fixed() +
  borders(database="world",
          regions="Norway(?!:Svalbard)", colour = "gray70", fill = "gray90",
          xlim=c(4.5, 32)) +
  geom_point(data = largest_providers,
             aes(x = decimalLongitude, 
                 y = decimalLatitude,
                 color = institutionCode),
             size = 0.5,
             alpha=0.5) +
  coord_quickmap() +
  facet_wrap(~institutionCode) +
  labs(color="Data provider") +
  theme_minimal() +
    theme(legend.position = "bottom") 
```

Another striking feature of the data, is the fact that NTNU university museum samples seem to be heavily localized in middle / northern Norway, while the two other data sets are more evenly distributed across the country, with the exception of the northernmost Finnmark region, where the sampling effort is low for all data sets.

## 4. Creating presence-absence dataset

From inspecting the cleaned dataset, we see that both the Environmental Agency and NINA are missing information on the sampling protocol. By comparison, the NTNU University Museum provides reliable information about the sampling method for nearly all samples (14173 of 14184 occurrences), sampling duration- and area (mostly), as well as individual counts, sampling duration- and area (mostly), and individual counts.

On the basis of this, we propose that the Environmental Agency and NINA data, together with the data from smaller providers, be treated as presence-only date, while the NTNU University Museum dataset has enough structure for us to construct a presence-absence dataset, given comparable samples taken with the same protocol where *B. rhodani* is absent.

In order to find these, we can look at the `datasetKey` column in the dataset, and make a new GBIF request based on that. As it turns out, nearly all the samples from the NTNU Science Museum originate from a single dataset, the [Freshwater benthic invertebrates ecological collection](https://www.gbif.org/dataset/33591b80-0e31-480c-82ce-2f57211b10e6), which contain data on \[more info here\].

We created a new download request with the same parameters as in 1.1., and filtered it to only contain samples obtained with sampling methods suitable for catching B. rhodani

be identified from the `datasetKey` column of the

The data from GBIF belongs to different datasets/data providers. Many sources do not reliably or consistently provide information about sampling structure, sampling methods etc. Therefore, such datasets will have to be treated as occurrence-only. However, for the data provided by the NTNU University Museum, there is enough information present to create a presence-absence dataset for *B. rhodani*. We here have reliable information about sampling method, sampling duration- and area (mostly), and individual counts. As seen in @fig-presence_absence

```{r plot-presence_absence}

#| label: fig-presence_absence
#| layout-ncol: 1
#| fig-cap: "Plot of presences/absences of _B. Rhodani_ from the NTNU Freshwater benthic invertebrates ecological collection, filtered by samples taken with comparable sampling protocols."

# Load data
load("data/derived_data/presence_absence_dataset.Rda")

# plot
ggplot() +
    coord_fixed() +
    borders(database="world",
            regions="Norway(?!:Svalbard)", colour = "gray70", fill = "gray90",
            xlim=c(4.5, 32)) +
    geom_point(data = events_NTNU,
               aes(x = as.numeric(decimalLongitude), y = as.numeric(decimalLatitude),
               colour = as.factor(presence)),
               size = 0.5) + 
  labs(color="Presence") +
  coord_quickmap() + 
  theme_minimal()
```

# Environmental variables

## CORINE land cover

We used land cover data from the CORINE database to \[...\]

```{r}

```

## NVE distance to main river

```{r}

```

## WORLDCLIM bioclimatic data

In order to model the species'

```{r}

```

# Integrated Species Distribution Model

Using species distribution models to investigate the distribution of the mayfly species *Baetis rhodani* in Norway. The goal is to compare the performance and predictions (?) of an SDM fitted using

1)  The entire dataset as presence-only data

2)  Only high-quality presence-absence coded data from structured sampling done by NTNU University museum. For this data, we have information on species occurrence, sampling method, and number of individuals per sampling unit.

3)  Only lower quality presence-only data.

4)  High quality NTNU University data, as well as lower-quality presence-only data.

```{r SDMs}
#| eval: false
# Run SDM script(s)
#source(here::here("code","5_integrated_SDM.R"))

### load models (new script?) ###
load("data/model_fits/po_full.rda")
load("data/model_fits/po_partial.rda")
load("data/model_fits/pa_only.rda")
load("data/model_fits/integrated.rda")

# Extract summary of the model
summary(modelRun_po_full)
summary(modelRun_po_partial)
summary(modelRun_pa_only)
summary(modelRun_integrated)

# Create a "region" from the shape of bio1_scaled
#get extent of raster
bio10_extent <- terra::ext(bio10_scaled)
#create an sf polygon from the extent
bio10_extent_sf <- st_as_sfc(st_bbox(c(bio10_extent[1], bio10_extent[2], 
                                       bio10_extent[3], bio10_extent[4])), 
                             crs = st_crs(bio10_scaled))
#create "region" object
region <- bio10_extent_sf

# Create prediction plots
predictions <- predict(modelRun_integrated, 
                       mesh = Mesh,
                       mask = Norway, 
                       spatial = TRUE,
                       fun = 'linear')

# Plot the prediction
plot(predictions)
```

::: {#fig-predictions layout-ncol="3"}
![Spatial predictions based on the presence-only model for the entire dataset.](plot_presence_only.png){#fig-po_pred} ![Spatial predictions based only on the presence-absence from the NTNU University museum.](plot_pa_only_mod.png){#fig-pa_pred} ![Spatial predictions based on the intergrated species distribution model.](plot_integrated_model.png){#fig-integrated_pred}

Spatial predictions from the three fitted models.
:::

# Citations

## Literature references

Manual reference list

-   Alp, M., Keller, I., Westram, A. M., & Robinson, C. T. (2012). How river structure and biological traits influence gene flow: a population genetic study of two stream invertebrates with differing dispersal abilities. *Freshwater Biology*, *57*(5), 969--981. https://doi.org/10.1111/j.1365-2427.2012.02758.x

-   Artsdatabanken (2021). **Vanlig smÃ¥dÃ¸gnflue *Baetis rhodani* (Pictet, 1843-45).** Retrieved 13.05.2024. <https://artsdatabanken.no/Taxon/Baetis%20rhodani/49481>

-   Bagge, P. (1995). Emergence and upstream flight of lotic mayflies and caddisflies (Ephemeroptera and Trichoptera) in a lake outlet, central Finland. *Entomologica Fennica*, *6*(2-3), 91--97. https://doi.org/10.33338/ef.83844

-   Peredo Arce, A., HÃ¶rren, T., Schletterer, M., & Kail, J. (2021). How far can EPTs fly? A comparison of empirical flying distances of riverine invertebrates and existing dispersal metrics. *Ecological Indicators*, *125*, 107465. https://doi.org/10.1016/j.ecolind.2021.107465

```{r}

```

## R packages

Citing R and packages used, including package version.

```{r}
# Citing all packages used, including the package versions.
report::cite_packages()
```
