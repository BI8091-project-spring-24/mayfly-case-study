---
title: "A protocol for GBIF data exploration and filtering for Integrated Species Distribution Models - with a practical example"
format: html
editor: visual
---

# Introduction

Modern ecological research is increasingly coming to be characterized by the use of large, multi-source data sets from open-access online repositories - with the infrastructure provided by the Global Biodiversity Information Facility (GBIF) as perhaps the most prominent example. These "big data" on species occurrences are often used to inform species distribution models. However, the fact that the data resulting from a single GBIF query (or a similar repository) often come from widely different sources, with different levels of sampling structure, information on species absences etc., remains a challenge.

Recent advances in species distribution modelling, exemplified with the release of the `R` package `pointedSDM` (Mostert & O'Hara, 2023), does increasingly allow for the combination of multiple species occurrence data sets with different levels of sample information (i.e. presence-only, presence-absence, counts etc), into a single integrated model (iSDM). Still, practical and actionable advice for how to best obtain, validate and prepare this differentiated data from an online repository, seems to be comparatively lacking in the literature.

In this report, we aim to address this issue by demonstrating a suggestion for a complete and reproducible workflow for data download, cleaning, exploration and differentiating, from a simple GBIF query to fitting an integrated SDM with the `pointedSDM` package.

## Case study

As a case study, we will use the occurrences of the mayfly species *Beatis rhodani*, whose GBIF occurrence data in Norway is known to contain both structured and unstructured samples. In order to assess the value of our approach over more "naïve" ways of modelling the data, we will compare the output of four different SDMs:

-   A presence-only version of our complete GBIF dataset

-   A presence-absence model of the subset of the data that is determined to be from structured survey

-   A presence-only model of the subset of the data,

-   An informed combination of the presence-absence and presence-only subsets of the data.

This report documents the different steps in the mayfly case study, created for the course Advanced biology BI8091 at NTNU, Spring 2024. The analysis consists of several steps: Selection of invertebrate data points, preparation of environmental variables, running the SDMs and interpreting/discussing the results and possible implications.

### Species distribution modelling

The aim of the project is to investigate how species distribution models can be used with different data types (presence-only, presence-absence, occurrence), and how the inclusion of both "good" and "less informative" data impact possible future predictions of species distribution. The R package pointedSDMs "[https://CRAN.R-project.org/package=PointedSDMs](https://cran.r-project.org/package=PointedSDMs)" by Mostert & O'hara is used for species distribution modelling.

### Study organism

The case study will focus on the mayfly species *Baetis rhodani* , also called the Large dark olive mayfly. Nymphs of *B. rhodani* is commonly found in running waters all over Norway (Artsdatabanken, 2021) and can also be found in most of Western-Europe. *B. rhodani* adults are winged and inhabit the terrestrial habitat for a limited time in order to reproduce. They cannot feed in their adult stage, so their life on land is short - typically lasting a few days. Not many studies have measured the dispersal distance of adult Mayflies. A study from 2021 aggregating flying distances for EPTs (Arce et al., 2021) cite only one study for *B. rhodani*, which had measured adults flying more than 3700 meters (Bagge, 1995).

We assume that most of the *B. rhodani* datapoints from Norway originate from aquatic sampling, which for some datasets can be verified (ie., the NTNU University Museum) and for others inferred based on proximity to the river network. Some adult Mayfiles may also show up in the dataset. This will be handled... (add text here).

### Data

Mayfly data is accessed through the Global Biodiversity Information Facility (GBIF, ref). Norway is selected as study area, due to the availability of both high-quality species occurrence data (NTNU University Museum) and presence-only data from national monitoring and research. Easily accessible physical, climatic and geographical data also makes Norway a good case-study.

# Workflow

## 0. Setup

Load packages: Downloading and loading required packages using a function that checks whether each package is already downloaded, and only downloads it if not present.

```{r 0_setup}
#| output: false
source(here::here("code","0_setup.R"))
```

## 1. Data download and exploration

### 1.1. Create download request for *Baetis rhodani* data from GBIF

In this project, we use data on the mayfly *Baetis rhodani* accessed via GBIF. The GBIF infrastructure provides several options for data download, which all require a GBIF user. Creating a user is free and open for all. Searching for and downloading data can be done via the GBIF website (link here), or it can be done via R using the "rgbif" package. We will demonstrate the latter, at it improves reproducibility.

First, a download request is created. This is shown in the script `1_1_GBIF_download.R`. Here we specify the download criteria:

-   Species: Baetis rhodani (Pictet, 1843)

-   Global administrative area: Norway

-   Basis of record: Everything

-   Year range: 1950-current

Then, the data is imported and saved as "insectdata.rda".

### 1.2. GBIF download using dataset key

Creating a download request from GBIF only needs to be done once. Afterwards, the dataset from the download request can be accessed directly through a download key or using a API-link. We use a download key to import the dataset. This can be done using the script `1_2_GBIF_import.R`

### 1.3. GBIF data cleaning

Before looking into the different sources and "quality levels" of the data, in the dataset, we first clean the downloaded dataset: removing data points with flagged coordinates, temporal outliers, and low coordinate precision (\>1km). The full cleaning procedure is provided in more detail in the script `1_3_GBIF_data_cleaning.R`.

#### Procedure (simplified):

-   Visualize the raw data

-   Then, remove records with problematic coordinates and plot the flagged records.

-   Finally, we test for temporal outliers on the taxon level, and remove the records

To improve the precision and our confidence in the data further, we can use the metadata included in the dataset.

-   First, make a boxplot of the coordinate precisions reported for the insect data.

-   Then, calculate some summary stats for the coordinate uncertainties, make a table of each value's frequency, and inspect it.

-   Then, remove records with coordinate uncertainty \>3km and records with NA for coordinate uncertainty.

-   Save the cleaned files. The cleaned dataset is now called `insectdata_low_uncertainty`.

The cleaned data is visualized in @fig-coords, with points removed in the cleaning procedure marked in red.

```{r plot-cleaned}
#| label: fig-coords
#| layout-ncol: 1
#| fig-cap: "Coordinates for the cleaned occurrences (blue, $N=23434$) of B. Rhodani in Norway, and removed points (red, $N=124$)."
#| truncate: true
load(here("data", "source_data","insectdata.rda"))
load(here("data/derived_data/cleaned_insectdata.rda"))

#filter out the filtered-out observations
removed_obs <- subset(insectdata, !(occurrenceID %in% cleaned_insectdata$occurrenceID))

# make plot of raw v cleaned obs
ggplot() +
  coord_fixed() +
  borders(database="world",
          regions="Norway(?!:Svalbard)", colour = "gray70", fill = "gray90",
          xlim=c(4.5, 32)) +
  geom_point(data = cleaned_insectdata,
             aes(x = decimalLongitude, y = decimalLatitude),
             colour = "darkblue",
             size = 0.5) +
  geom_point(data = removed_obs,
             aes(x = decimalLongitude, y = decimalLatitude),
             colour = "red",
             size = 0.5) +
  coord_quickmap() +
  theme_classic()
```

```{r coord_summary}

# Read data in 
load(here("data", "derived_data" ,"coordinate_uncertainty_df.Rda"))

# Which Coordinate uncertainty value is most common?
sorted_value_counts <- sort(coordinate_uncertainty_df, decreasing = TRUE)

# Create table of the frequency of each cooridinate uncertainty
rmarkdown::paged_table(data.frame(sorted_value_counts))
```

Then, remove records with coordinate uncertainty \>1km and records with NA for coordinate uncertainty. 60 records were reomved as part of this filtering.

Save the cleaned files. The cleaned dataset is now called insectdata_low_uncertainty (?).

### 1.4. Data exploration

The cleaned data originates from different data providers. The 10 largest data sources are shown below, and we see that after The University Museum (NTNU-VM), The Environment Agency (miljodir) and The Norwegian Institute for Nature Research (NINA) are the instiutions providing the highest number of data points.

```{r}
###
# THIS SECTION WILL BE REMOVED, AND WILL JUST RUN SEPARATE SCRIPT AND USE KNITR TO ADD FIGURE (having some issues)
# Load cleaned insectdata
load(here::here("data","derived_data","cleaned_insectdata.rda"))

# Summarize the number of occurrences by institution
df_institutions <- cleaned_insectdata %>%
  group_by(institutionCode) %>%
  summarize(N_occurrences = length(occurrenceID))%>%
  mutate(across(where(is.character), ~ na_if(.,""))) %>%
  filter(!is.na(institutionCode))

# Plot figure for top 10 institutions
df_institutions_barplot <- df_institutions %>% 
  arrange(desc(N_occurrences)) %>%
  slice(1:10) %>%
  ggplot(., aes(x = reorder(institutionCode,-N_occurrences), y = N_occurrences)) + 
  geom_bar(stat = "identity") +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  xlab("Institution") + 
  ylab("Number of occurrences") +
  theme_classic()

df_institutions_barplot
###

```

As visualized in @fig-institutions-points, the *B. rhodani* data points are distributed across Norway, with higher concentrations of data points visible near large cities.

```{r plot-institutions}
#| label: fig-institutions-points
#| layout-ncol: 1
#| fig-cap: "Coordinates for the samples provided by the the largest data providers in the study: The NTNU University Museum (NTNU-VM), the Norwegian Environmental Agency (miljodir) and the Norwegian Institute for Nature Research (NINA)."
#| truncate: true
largest_providers <- cleaned_insectdata |> filter(institutionCode %in% c("NTNU-VM", "miljodir", "NINA"))
ggplot() +
  coord_fixed() +
  borders(database="world",
          regions="Norway(?!:Svalbard)", colour = "gray70", fill = "gray90",
          xlim=c(4.5, 32)) +
  geom_point(data = largest_providers,
             aes(x = decimalLongitude, 
                 y = decimalLatitude,
                 color = institutionCode),
             size = 0.5,
             alpha=0.5) +
  coord_quickmap() +
  facet_wrap(~institutionCode) +
  labs(color="Data provider") +
  theme_minimal() +
    theme(legend.position = "bottom") 
```

Another distinct feature of the data, is the fact that NTNU university museum samples seem to be heavily localized in middle / northern Norway, while the two other data sets are more evenly distributed across the country, with the exception of the northernmost Finnmark region, where the sampling effort is low for all data sets.

### 1.5. Creating presence-absence dataset

From inspecting the cleaned dataset, we see that both the Environmental Agency and NINA are missing information on the sampling protocol. By comparison, the NTNU University Museum provides reliable information about the sampling method for nearly all samples (14173 of 14184 occurrences), sampling duration- and area (mostly), as well as individual counts, sampling duration- and area (mostly), and individual counts.

On the basis of this, we propose that the Environmental Agency and NINA data, together with the data from smaller providers, be treated as presence-only date, while the NTNU University Museum dataset has enough structure for us to construct a presence-absence dataset, given comparable samples taken with the same protocol where *B. rhodani* is absent.

In order to find these, we can look at the `datasetKey` column in the dataset, and make a new GBIF request based on that. As it turns out, nearly all the samples from the NTNU Science Museum originate from a single dataset, the [Freshwater benthic invertebrates ecological collection](https://www.gbif.org/dataset/33591b80-0e31-480c-82ce-2f57211b10e6).

We created a new download request with the same parameters as in 1.1., and filtered it to only contain samples obtained with sampling methods suitable for catching *B. rhodani*. Details on this procedure can be found in the script `1_5_GBIF_presence_absence_dataset.R`.

```{r plot-presence_absence}
#| label: fig-presence_absence
#| layout-ncol: 1
#| fig-cap: "Plot of presences/absences (1/0) of _B. Rhodani_ from the NTNU Freshwater benthic invertebrates ecological collection, filtered by samples taken with comparable sampling protocols."

# Load data
load("data/derived_data/presence_absence_dataset.Rda")

# plot
ggplot() +
    coord_fixed() +
    borders(database="world",
            regions="Norway(?!:Svalbard)", colour = "gray70", fill = "gray90",
            xlim=c(4.5, 32)) +
    geom_point(data = events_NTNU,
               aes(x = as.numeric(decimalLongitude), y = as.numeric(decimalLatitude),
               colour = as.factor(presence)),
               size = 0.5) + 
  labs(color="Presence") +
  coord_quickmap() + 
  theme_minimal()
```

# CORINE land cover

To map the distribution of *B. rhodani*, we use the CORINE Land Cover (CLC) Status 2018 product. CLC has a resolution of 100m x 100m and contains 44 land cover classes. For the purposes of our analysis, the 44 original classes were aggregated into the 10 classes below. Here, we plotted the land cover across Norway as detected by the CLC Status 2018 layer.

![](images/corine_2018_norway.png)

# WORLDCLIM environmental variable

We also used the Worldclim bioclimatic variables to map the distribution of *B. rhodani.* Specifically, we used bioclim10, Mean Temperature of The Warmest Quarter at a 30 arc second resolution (\~ 1km\^2). Below, we plotted the distribution of the bio10 values across Norway.

![](images/bio10_norway.png)

## 5. Integrated Species Distribution Model

\[A few lines about how we set up the model\]. See the script `5_integrated_SDM.R` for more details.

# Results and discussion

\[say sometyhing (short) about the results of th SDMs and their interpretations.\]

```{r SDMs}
#| eval: false
#| echo: false
# Run SDM script(s)
#source(here::here("code","5_integrated_SDM.R"))

### load models (new script?) ###
load("data/model_fits/po_full.rda")
load("data/model_fits/po_partial.rda")
load("data/model_fits/pa_only.rda")
load("data/model_fits/integrated.rda")

# Extract summary of the model
summary(modelRun_po_full)
summary(modelRun_po_partial)
summary(modelRun_pa_only)
summary(modelRun_integrated)

# Create a "region" from the shape of bio1_scaled
#get extent of raster
bio10_extent <- terra::ext(bio10_scaled)
#create an sf polygon from the extent
bio10_extent_sf <- st_as_sfc(st_bbox(c(bio10_extent[1], bio10_extent[2], 
                                       bio10_extent[3], bio10_extent[4])), 
                             crs = st_crs(bio10_scaled))
#create "region" object
region <- bio10_extent_sf

# Create prediction plots
predictions <- predict(modelRun_integrated, 
                       mesh = Mesh,
                       mask = Norway, 
                       spatial = TRUE,
                       fun = 'linear')

# Plot the prediction
plot(predictions)

```

# Citations

## Literature references

Manual reference list

-   Alp, M., Keller, I., Westram, A. M., & Robinson, C. T. (2012). How river structure and biological traits influence gene flow: a population genetic study of two stream invertebrates with differing dispersal abilities. *Freshwater Biology*, *57*(5), 969--981. https://doi.org/10.1111/j.1365-2427.2012.02758.x

-   Artsdatabanken (2021). **Vanlig smådøgnflue *Baetis rhodani* (Pictet, 1843-45).** Retrieved 13.05.2024. <https://artsdatabanken.no/Taxon/Baetis%20rhodani/49481>

-   Bagge, P. (1995). Emergence and upstream flight of lotic mayflies and caddisflies (Ephemeroptera and Trichoptera) in a lake outlet, central Finland. *Entomologica Fennica*, *6*(2-3), 91--97. https://doi.org/10.33338/ef.83844

-   Peredo Arce, A., Hörren, T., Schletterer, M., & Kail, J. (2021). How far can EPTs fly? A comparison of empirical flying distances of riverine invertebrates and existing dispersal metrics. *Ecological Indicators*, *125*, 107465. https://doi.org/10.1016/j.ecolind.2021.107465

Citing R and packages used, including package version.

```{r}
# Citing all packages used, including the package versions.
report::cite_packages()
```
