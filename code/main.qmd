---
title: "A practical application of the pointedSDM package (with a reproducible workflow)"
format: html
editor: visual
---

# Introduction

\[alternative title suggestion: A protocol for GBIF data exploration and filtering for Integrated Species Distribution Models\]

Modern ecological research is increasingly coming to be characterized by the use of large, multi-source data sets from open-access online repositories - with the infrastructure provided by the Global Biodiversity Information Facility (GBIF) as perhaps the most prominent example. These "big data" on species occurrences are often used to inform species distribution models, where \[say something more here?\]. However, the fact that the data resulting from a single GBIF query (or a similar repository) often come from widely different sources, with different levels of sampling structure, information on species absences etc., remains a challenge.

Recent advances in species distribution modelling, exemplified with the release of the `R` package `pointedSDM` (REF), does increasingly allow for the combination of multiple species occurrence data sets with different levels of sample information (i.e. presence-only, presence-absence, counts etc), into a single integrated model (iSDM). Still, practical and actionable advice for how to best obtain, validate and prepare this differentiated data from an online repository, seems to be comparatively lacking in the literature.

In this report, we aim to address this issue by demonstrating a suggestion for a complete and reproducible workflow for data download, cleaning, exploration and differentiating, from a simple GBIF query to fitting an integrated SDM with the `pointedSDM` package.

## Case study

As a case study, we will use the occurrences of the mayfly species *Beatis rhodani*, whose GBIF occurrence data in Norway is known to contain both structured and unstructured samples. In order to assess the value of our approach over more "naïve" ways of modelling the data, we will compare the output of four different SDMs: a presence-only version of our complete GBIF dataset, a presence-absence model of the subset of the data that is determined to be from structured survey, a presence-only model of the subset of the data, and an informed combination of the presence-absence and presence-only subsets of the data.

Study: A practical application of the pointedSDM package (with a reproducible workflow).

This report documents the different steps in the mayfly case study, created for the course Advanced biology BI8091 at NTNU, Spring 2024. The analysis consists of several steps: Selection of invertebrate data points, preparation of environmental variables, running the SDMs and interpreting/discussing the results and possible implications.

### Species distribution modelling

The aim of the project is to investigate how species distribution models can be used with different data types (presence-only, presence-absence, occurrence), and how the inclusion of both "good" and "less informative" data impact possible future predictions of species distribution. The R package pointedSDMs "[https://CRAN.R-project.org/package=PointedSDMs](https://cran.r-project.org/package=PointedSDMs)" by Mostert & O'hara is used for species distribution modelling.

### Study organism

The case study will focus on the mayfly species *Baetis rhodani* , also called the Large dark olive mayfly. Nymphs of *B. rhodani* is commonly found in running waters all over Norway (Artsdatabanken, 2021) and can also be found in most of Western-Europe. *B. rhodani* adults are winged and inhabit the terrestrial habitat for a limited time in order to reproduce. They cannot feed in their adult stage, so their life on land is short - typically lasting a few days. Not many studies have measured the dispersal distance of adult Mayflies. A study from 2021 aggregating flying distances for EPTs (Arce et al., 2021) cite only one study for *B. rhodani*, which had measured adults flying more than 3700 meters (Bagge, 1995).

We assume that most of the *B. rhodani* datapoints from Norway originate from aquatic sampling, which for some datasets can be verified (ie., the NTNU University Museum) and for others inferred based on proximity to the river network. Some adult Mayfiles may also show up in the dataset. This will be handled... (add text here).

### Data

Mayfly data is accessed through the Global Biodiversity Information Facility (GBIF, ref). Norway is selected as study area, due to the availability of both high-quality species occurrence data (NTNU University Museum) and presence-only data from national monitoring and research. Easily accessible physical, climatic and geographical data also makes Norway a good case-study.

# Setup

Load packages: Downloading and loading required packages using a function that checks whether each package is already downloaded, and only downloads it if not present.

```{r 0_setup}
#| output: false

source(here::here("code","0_setup.R"))
```

# Load *Baetis rhodani* data from GBIF

In this project, we use data on the mayfly *Baetis rhodani* accessed via GBIF. The GBIF infrastructure provides several options for data download, which all require a GBIF user. Creating a user is free and open for all. Searching for and downloading data can be done via the GBIF website (link here), or it can be done via R using the "rgbif" package. We will demonstrate the latter, at it improves reproducibility.

First, a download request is created. Here we specify the download criteria:

-   Species: Baetis rhodani (Pictet, 1843)

-   Global administrative area: Norway

-   Basis of record: Everything

-   Year range: 1950-current

Then, the data is imported and saved as "insectdata.rda". Creating a download request from GBIF only needs to be done once. Afterwards, the dataset from the download request can be accessed directly through a download key or using a API-link. We use a download key to import the dataset.

```{r load_GBIF_data }
#| output: true
#| error: true

# Load script: GBIF download
# source(here::here("code","1_1_GBIF_download.R"))
  # Script for creating a new download request to GBIF. Only run if necessary.

# Load script: GBIF import
source(here::here("code","1_2_GBIF_import.R"))

```

# GBIF data cleaning

## 1. Remove flagged coordinate and time records

First we plotted the records on a world map in order to assess whether there are any downloaded records falling outside of Norway.

![](images/insect_records_world_map.png){fig-align="center"}

All downloaded records fall within Norway, as expected.

Then, we checked our records for problematic coordinates. In the entire dataset, only 3 records were flagged for having country centroids as the coordinate values. These records were then removed from the dataset. The flagged records have the value "FALSE" in the plot below.

![](images/flagged_insect_records-02.png)

Finally, we test for temporal outliers on the taxon level, and remove the eight records that were flagged.

## 2. Use metadata to improve data quality

To improve the precision and our confidence in the data further, we can use the metadata included in the dataset.

First, we make a boxplot of the coordinate precisions reported for the insect data. Our boxplot shows that some records have very high coordinate uncertainty (m).

![](images/coord_uncertainty_plot.png)

Then, we calculate some summary stats for the coordinate uncertainties, make a table of each value's frequency, and inspect it:

```{r coord_summary}

# Read data in 
load(here("data", "derived_data" ,"coordinate_uncertainty_df.Rda"))

# Which Coordinate uncertainty value is most common?
sorted_value_counts <- sort(coordinate_uncertainty_df, decreasing = TRUE)

# Create table of the frequency of each cooridinate uncertainty
rmarkdown::paged_table(data.frame(sorted_value_counts))
```

Then, remove records with coordinate uncertainty \>1km and records with NA for coordinate uncertainty. 60 records were reomved as part of this filtering.

Save the cleaned files. The cleaned dataset is now called insectdata_low_uncertainty (?).

## Load cleaned datafiles

Alternative to running all the cleaning steps.

```{r load_cleaned_datafiles}
load(here::here("data","derived_data","insectdata_no_flags.rda"))

load(here::here("data","derived_data","insectdata_low_uncertainty.rda"))

```

# Data exploration

The cleaned data originates from different data providers. The 10 largest data sources are shown below, and we see that after The University Museum (NTNU-VM), The Environment Agency (miljodir) and The Norwegian Institute for Nature Research (NINA) are the instiutions providing the highest number of datapoints.

```{r}
# Run script
source(here::here("code","1_4_GBIF_data_exploration.R"))

# Add a table/figure summarizing the top-10 data sources.
# knitr::include_graphics(here::here("results","top_10_institutions.jpg"))

###
# THIS SECTION WILL BE REMOVED, AND WILL JUST RUN SEPARATE SCRIPT AND USE KNITR TO ADD FIGURE (having some issues)
# Load cleaned insectdata
load(here::here("data","derived_data","cleaned_insectdata.rda"))

# Summarize the number of occurrences by institution
df_institutions <- cleaned_insectdata %>%
  group_by(institutionCode) %>%
  summarize(N_occurrences = length(occurrenceID))%>%
  mutate(across(where(is.character), ~ na_if(.,""))) %>%
  filter(!is.na(institutionCode))

# Plot figure for top 10 institutions
df_institutions_barplot <- df_institutions %>% 
  arrange(desc(N_occurrences)) %>%
  slice(1:10) %>%
  ggplot(., aes(x = reorder(institutionCode,-N_occurrences), y = N_occurrences)) + 
  geom_bar(stat = "identity") +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  xlab("Institution") + 
  ylab("Number of occurrences") +
  theme_classic()

df_institutions_barplot
###

```

However, both The Environment Agency and NINA are missing information on sampling protocol. They will, together with the smaller datasets, be treated as presence-only data.

```{r}
only_mdir <- insectdata_low_uncertainty |> filter(institutionCode == "miljodir")
as.data.frame(table(only_mdir$samplingProtocol))

only_nina <- insectdata_low_uncertainty |> filter(institutionCode == "NINA")
as.data.frame(table(only_nina$samplingProtocol))

```

The *B. rhodani* data points are distributed across Norway, with higher concentrations of data points visible near large cities. We here plot the Environment Agency and NINA data:

```{r}
ggplot() +
  coord_fixed() +
  geom_point(data = only_mdir,
             aes(x = decimalLongitude, y = decimalLatitude),
             colour = "darkred",
             size = 0.5) +
  ggtitle("Only The Environment Agency (Miljodirektoratet)") +
  theme_classic()

ggplot() +
  coord_fixed() +
  geom_point(data = only_nina,
             aes(x = decimalLongitude, y = decimalLatitude),
             colour = "darkred",
             size = 0.5) +
  ggtitle("Only NINA") +
  theme_classic()
```

# Creating presence-absence dataset

The data from GBIF belongs to different datasets/data providers. Many sources do not reliably or consistently provide information about sampling structure, sampling methods etc. Therefore, such datasets will have to be treated as occurrence-only. However, for the data provided by the NTNU University Museum, there is enough information present to create a presence-absence dataset for *B. rhodani*. We here have reliable information about sampling method, sampling duration- and area (mostly), and individual counts.

```{r}
# Run script
source(here::here("code","1_4_GBIF_presence_absence_dataset.R"))
```

![](images/presence_absence_map.png)

Here, we have plotted the distribution of the presences (A) and absences (B) of *B. rhodani*. contained in NTNU University Museum dataset, with different colours representing different sampling methods.

# CORINE land cover

To map the distribution of *B. rhodani*, we use the CORINE Land Cover (CLC) Status 2018 product. CLC has a resolution of 100m x 100m and contains 44 land cover classes. For the purposes of our analysis, the 44 original classes were aggregated into the 10 classes below. Here, we plotted the land cover across Norway as detected by the CLC Status 2018 layer.

![](images/corine_2018_norway.png)

# NVE distance to river

```{r}

```

# WORLDCLIM environmental variable

We also used the Worldclim bioclimatic variables to map the distribution of *B. rhodani.* Specifically, we used bioclim10, Mean Temperature of The Warmest Quarter at a 30 arc second resolution (\~ 1km\^2). Below, we plotted the distribution of the bio10 values across Norway.

![](images/bio10_norway.png)

# Integrated Species Distribution Model

Using species distribution models to investigate the distribution of the mayfly species *Baetis rhodani* in Norway. The goal is to compare the performance and predictions (?) of a SDM using

1)  Only high-quality data from structured sampling done by NTNU University museum. For this data, we have information on species occurrence, sampling method, and number of individuals per sampling unit.

2)  Only lower quality presence-only data.

3)  High quality NTNU University data as in 1, as well as lower-quality presence-only data.

```{r SDMs}
# Run SDM script(s)
source(here::here("code","5_integrated_SDM.R"))

```

# Citations

## Literature references

Manual reference list

-   Alp, M., Keller, I., Westram, A. M., & Robinson, C. T. (2012). How river structure and biological traits influence gene flow: a population genetic study of two stream invertebrates with differing dispersal abilities. *Freshwater Biology*, *57*(5), 969--981. https://doi.org/10.1111/j.1365-2427.2012.02758.x

-   Artsdatabanken (2021). **Vanlig smådøgnflue *Baetis rhodani* (Pictet, 1843-45).** Retrieved 13.05.2024. <https://artsdatabanken.no/Taxon/Baetis%20rhodani/49481>

-   Bagge, P. (1995). Emergence and upstream flight of lotic mayflies and caddisflies (Ephemeroptera and Trichoptera) in a lake outlet, central Finland. *Entomologica Fennica*, *6*(2-3), 91--97. https://doi.org/10.33338/ef.83844

-   Peredo Arce, A., Hörren, T., Schletterer, M., & Kail, J. (2021). How far can EPTs fly? A comparison of empirical flying distances of riverine invertebrates and existing dispersal metrics. *Ecological Indicators*, *125*, 107465. https://doi.org/10.1016/j.ecolind.2021.107465

```{r}

```

## R packages

Citing R and packages used, including package version.

```{r}
# Citing all packages used, including the package versions.
report::cite_packages()
```
